# PLAN DE IMPLEMENTACIÓN EN SUPABASE PARA "SIST_AGENTICO_HOTELERO" (v2.0 - Revisado)

**Versión:** 2.0
**Fecha:** 2025-11-14
**Objetivo:** Servir como guía técnica detallada para configurar la infraestructura de Supabase, incorporando mejoras de robustez, seguridad y escalabilidad.

---

## FASE 1: DISEÑO Y ESTRUCTURA DE LA BASE DE DATOS

### 1.1. Creación de Tipos de Datos Personalizados (ENUMs)

**Propósito:** Asegurar la integridad de los datos para campos con valores predefinidos. Ejecuta esto primero.

```sql
-- CREAR LOS TIPOS ENUM
CREATE TYPE user_role AS ENUM ('admin', 'gerente', 'huesped');
CREATE TYPE habitacion_status AS ENUM ('disponible', 'ocupada', 'mantenimiento');
CREATE TYPE reserva_status AS ENUM ('confirmada', 'cancelada', 'completada', 'pendiente');
```

### 1.2. Creación de Tablas (Esquema SQL Mejorado)

**Propósito:** Crear el esquema usando los tipos de datos robustos.

```sql
-- Tabla para perfiles de usuario
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT,
  avatar_url TEXT,
  role user_role NOT NULL DEFAULT 'huesped',
  hotel_id BIGINT REFERENCES public.hoteles(id) ON DELETE SET NULL
);
COMMENT ON TABLE public.profiles IS 'Almacena información adicional, el rol del usuario y el hotel asociado (para gerentes).';

-- Tabla para la información de los hoteles
CREATE TABLE public.hoteles (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  name TEXT NOT NULL,
  description TEXT,
  address TEXT,
  city TEXT,
  country TEXT,
  image_url TEXT,
  contact_email TEXT
);

-- Tabla para las habitaciones de cada hotel
CREATE TABLE public.habitaciones (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  hotel_id BIGINT NOT NULL REFERENCES public.hoteles(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  room_number TEXT NOT NULL,
  type TEXT NOT NULL,
  capacity INT NOT NULL DEFAULT 1,
  price_per_night NUMERIC(10, 2) NOT NULL,
  status habitacion_status NOT NULL DEFAULT 'disponible',
  image_urls JSONB
);

-- Tabla para gestionar las reservas
CREATE TABLE public.reservas (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  habitacion_id BIGINT NOT NULL REFERENCES public.habitaciones(id) ON DELETE RESTRICT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  check_in_date DATE NOT NULL,
  check_out_date DATE NOT NULL,
  total_price NUMERIC(10, 2) NOT NULL,
  status reserva_status NOT NULL DEFAULT 'pendiente',
  number_of_guests INT NOT NULL DEFAULT 1,
  CONSTRAINT check_out_after_check_in CHECK (check_out_date > check_in_date)
);
```

### 1.3. Creación de Índices para Performance

**Propósito:** Optimizar la velocidad de las consultas a medida que los datos crecen.

```sql
-- Índices para llaves foráneas y búsquedas comunes
CREATE INDEX idx_profiles_hotel_id ON public.profiles(hotel_id);
CREATE INDEX idx_habitaciones_hotel_id ON public.habitaciones(hotel_id);
CREATE INDEX idx_reservas_user_id ON public.reservas(user_id);
CREATE INDEX idx_reservas_habitacion_id ON public.reservas(habitacion_id);

-- Índice compuesto para la búsqueda de disponibilidad de reservas
CREATE INDEX idx_reservas_disponibilidad ON public.reservas(habitacion_id, check_in_date, check_out_date);

-- Índice en estados para filtrar rápidamente
CREATE INDEX idx_habitaciones_status ON public.habitaciones(status);
CREATE INDEX idx_reservas_status ON public.reservas(status);
```

### 1.4. Habilitación y Políticas de Seguridad (RLS)

**Propósito:** Definir permisos de acceso granulares para proteger los datos.

```sql
-- Habilitar RLS en todas las tablas
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.hoteles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.habitaciones ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.reservas ENABLE ROW LEVEL SECURITY;

-- Políticas para 'profiles'
CREATE POLICY "Usuarios pueden ver y modificar su propio perfil" ON public.profiles FOR ALL USING (auth.uid() = id);

-- Políticas para 'hoteles' y 'habitaciones' (Lectura pública)
CREATE POLICY "Permitir lectura de hoteles a usuarios autenticados" ON public.hoteles FOR SELECT TO authenticated USING (true);
CREATE POLICY "Permitir lectura de habitaciones a usuarios autenticados" ON public.habitaciones FOR SELECT TO authenticated USING (true);

-- Políticas para 'reservas'
CREATE POLICY "Usuarios pueden gestionar sus propias reservas" ON public.reservas FOR ALL USING (auth.uid() = user_id);

-- Políticas para ROL 'gerente'
CREATE POLICY "Gerentes pueden ver las reservas de su hotel" ON public.reservas FOR SELECT
  USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'gerente' AND habitacion_id IN (SELECT id FROM public.habitaciones WHERE hotel_id = (SELECT hotel_id FROM public.profiles WHERE id = auth.uid())));

CREATE POLICY "Gerentes pueden gestionar las habitaciones de su hotel" ON public.habitaciones FOR ALL
  USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'gerente' AND hotel_id = (SELECT hotel_id FROM public.profiles WHERE id = auth.uid()));

-- Políticas para ROL 'admin'
CREATE POLICY "Acceso total para administradores" ON public.profiles FOR ALL USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Acceso total para administradores" ON public.hoteles FOR ALL USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Acceso total para administradores" ON public.habitaciones FOR ALL USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');
CREATE POLICY "Acceso total para administradores" ON public.reservas FOR ALL USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin');
```