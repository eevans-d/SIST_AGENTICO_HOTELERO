groups:
  - name: agente-general
    interval: 30s
    rules:
      - alert: HighHttp5xxRate
        expr: sum by (endpoint) (rate(http_requests_total{status_code=~"5.."}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alta tasa de 5xx en {{ $labels.endpoint }}"
          description: "La tasa de respuestas 5xx supera 0.1 rps en {{ $labels.endpoint }} durante 5m."
          runbook_url: "https://grafana.local/runbooks#highhttp5xxrate"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=2"

      - alert: HighWebhook429Rate
        expr: sum(rate(http_requests_total{endpoint="/webhooks/whatsapp",status_code="429"}[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rate limit alcanzado en webhook"
          description: "Se detecta tasa de 429 > 0.2 rps en /webhooks/whatsapp."

      - alert: HighPmsLatencyP95
        expr: histogram_quantile(0.95, sum by (le) (rate(pms_api_latency_seconds_bucket[5m]))) > 1
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Latencia p95 alta contra PMS"
          description: "p95 de latencia de PMS > 1s por más de 10m."
          runbook_url: "https://grafana.local/runbooks#highpmslatencyp95"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=3"

      - alert: CircuitBreakerOpen
        expr: max_over_time(pms_circuit_breaker_state[1m]) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Circuit Breaker abierto"
          description: "El estado del Circuit Breaker del PMS > 0 por más de 2m."
          runbook_url: "https://grafana.local/runbooks#circuitbreakeropen"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=5"

      - alert: DependencyDown
        expr: (min_over_time(readiness_up[2m]) < 1) and (time() - readiness_last_check_timestamp < 300)
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Alguna dependencia está caída"
          description: "El readiness general está en 0 durante más de 2m y hubo checks recientes (<5m). Revisar /health/ready y métricas dependency_up."
          runbook_url: "https://grafana.local/runbooks#dependencydown"
          dashboard: "grafana:/d/readiness-overview/Readiness%20%26%20Dependencies"

      - alert: OrchestratorHighErrorRateWarning
        expr: (sum by (intent) (rate(orchestrator_errors_total[5m])) / sum by (intent) (rate(orchestrator_messages_total[5m]))) > 0.05 and sum by (intent) (rate(orchestrator_messages_total[5m])) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Alta tasa de errores en Orchestrator (warning)"
          description: "El error rate del orquestador por intent > 5% durante 10m con tráfico > 0.2 rps. Revisar logs e integraciones (PMS, NLP)."
          runbook_url: "https://grafana.local/runbooks#orchestratorhigherrorrate"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=11"

      - alert: OrchestratorHighErrorRateCritical
        expr: (sum by (intent) (rate(orchestrator_errors_total[5m])) / sum by (intent) (rate(orchestrator_messages_total[5m]))) > 0.2 and sum by (intent) (rate(orchestrator_messages_total[5m])) > 0.5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Alta tasa de errores en Orchestrator (critical)"
          description: "El error rate del orquestador por intent > 20% durante 5m con tráfico > 0.5 rps. Priorizar investigación."
          runbook_url: "https://grafana.local/runbooks#orchestratorhigherrorrate"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=11"

      - alert: OrchestratorHighLatencyP95
        expr: max by (intent) (histogram_quantile(0.95, sum by (le, intent) (rate(orchestrator_latency_seconds_bucket[5m])))) > 2
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Latencia p95 alta en Orchestrator"
          description: "El p95 de latencia del orquestador supera 2s durante 10m para algún intent. Revisar dependencias (PMS, Redis) y carga."
          runbook_url: "https://grafana.local/runbooks#orchestratorhighlatencyp95"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=8"

      - alert: OrchestratorSLODegradationWarning
        expr: orchestrator_success_rate_all < 99 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "SLO del Orchestrator en degradación (warning)"
          description: "El success rate global del orquestador está por debajo de 99% durante 30m. Revisar intents con mayor error% y dependencias."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=12"

      - alert: OrchestratorSLODegradationCritical
        expr: orchestrator_success_rate_all < 97 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "SLO del Orchestrator en degradación (critical)"
          description: "El success rate global del orquestador está por debajo de 97% durante 10m. Atender de inmediato; revisar intents top-k por error% y latencia."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=12"

      # Burn rate SLO 99% (error budget 1%) - multi-ventana
      - alert: OrchestratorSLOBurnRateWarning
        expr: (orchestrator_burn_rate_fast > 2) and (orchestrator_burn_rate_slow > 1) and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "SLO burn rate alto (warning)"
          description: "Consumo acelerado del error budget: fast>2 y slow>1. Chequear intents con mayor error% y latencia."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=14"

      - alert: OrchestratorSLOBurnRateCritical
        expr: (orchestrator_burn_rate_fast2 > 14.4) and (orchestrator_burn_rate_slow2 > 6) and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "SLO burn rate crítico"
          description: "Consumo muy alto del error budget: fast2>14.4 y slow2>6. Atender de inmediato."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=14"

      - alert: OrchestratorSLOBudgetExhaustForecastWarning
        expr: orchestrator_error_budget_hours_to_exhaust_fast > 0 and orchestrator_error_budget_hours_to_exhaust_fast < 12 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "SLO: presupuesto se agotará (<12h)"
          description: "Proyección indica agotamiento del error budget en <12h (ventana fast). Iniciar mitigaciones y reducción de errores."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/slo-health/SLO%20Health"

      - alert: OrchestratorSLOBudgetExhaustForecastCritical
        expr: orchestrator_error_budget_hours_to_exhaust_fast > 0 and orchestrator_error_budget_hours_to_exhaust_fast < 6 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "SLO: presupuesto se agotará (<6h)"
          description: "Proyección indica agotamiento del error budget en <6h (ventana fast). Escalar incidente y priorizar resolución."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/slo-health/SLO%20Health"

      - alert: PmsCacheHitRatioLowWarning
        expr: pms_cache_hit_ratio < 0.7 and (sum(rate(pms_cache_hits_total[5m])) + sum(rate(pms_cache_misses_total[5m])) > 0.2)
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "PMS cache hit ratio bajo (warning)"
          description: "Hit ratio < 70% durante 15m con actividad de cache > 0.2 ops/s. Revisar caducidad TTL, patrones de key o invalidaciones excesivas."
          runbook_url: "https://grafana.local/runbooks#pmscachehitratio"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=21"

      - alert: PmsCacheHitRatioLowCritical
        expr: pms_cache_hit_ratio < 0.5 and (sum(rate(pms_cache_hits_total[5m])) + sum(rate(pms_cache_misses_total[5m])) > 0.2)
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "PMS cache hit ratio muy bajo (critical)"
          description: "Hit ratio < 50% durante 10m con actividad de cache > 0.2 ops/s. Impacto potencial en latencia hacia PMS. Aplicar mitigaciones inmediatas."
          runbook_url: "https://grafana.local/runbooks#pmscachehitratio"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=21"

      # ----------------------------------------------------------------------
      # Prueba rápida (comentada por defecto)
      # Descomentar para probar pipeline de alertas; recuerda volver a comentar.
      # - alert: AlwaysFiring
      #   expr: vector(1)
      #   for: 1m
      #   labels:
      #     severity: critical
      #   annotations:
      #     summary: "Alerta de prueba (AlwaysFiring)"
      #     description: "Alerta sintética para validar receivers y ruteo."
