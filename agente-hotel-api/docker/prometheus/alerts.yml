groups:
  - name: agente-general
    interval: 30s
    rules:
      - alert: HighHttp5xxRate
        expr: sum by (endpoint) (rate(http_requests_total{status_code=~"5.."}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alta tasa de 5xx en {{ $labels.endpoint }}"
          description: "La tasa de respuestas 5xx supera 0.1 rps en {{ $labels.endpoint }} durante 5m."
          runbook_url: "https://grafana.local/runbooks#highhttp5xxrate"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=2"

      - alert: HighWebhook429Rate
        expr: sum(rate(http_requests_total{endpoint="/webhooks/whatsapp",status_code="429"}[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rate limit alcanzado en webhook"
          description: "Se detecta tasa de 429 > 0.2 rps en /webhooks/whatsapp."

      - alert: HighPmsLatencyP95
        expr: histogram_quantile(0.95, sum by (le) (rate(pms_api_latency_seconds_bucket[5m]))) > 1
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Latencia p95 alta contra PMS"
          description: "p95 de latencia de PMS > 1s por más de 10m."
          runbook_url: "https://grafana.local/runbooks#highpmslatencyp95"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=3"

      - alert: CircuitBreakerOpen
        expr: max_over_time(pms_circuit_breaker_state[1m]) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Circuit Breaker abierto"
          description: "El estado del Circuit Breaker del PMS > 0 por más de 2m."
          runbook_url: "https://grafana.local/runbooks#circuitbreakeropen"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=5"

      - alert: DependencyDown
        expr: (min_over_time(readiness_up[2m]) < 1) and (time() - readiness_last_check_timestamp < 300)
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Alguna dependencia está caída"
          description: "El readiness general está en 0 durante más de 2m y hubo checks recientes (<5m). Revisar /health/ready y métricas dependency_up."
          runbook_url: "https://grafana.local/runbooks#dependencydown"
          dashboard: "grafana:/d/readiness-overview/Readiness%20%26%20Dependencies"

      - alert: OrchestratorHighErrorRateWarning
        expr: (sum by (intent) (rate(orchestrator_errors_total[5m])) / sum by (intent) (rate(orchestrator_messages_total[5m]))) > 0.05 and sum by (intent) (rate(orchestrator_messages_total[5m])) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Alta tasa de errores en Orchestrator (warning)"
          description: "El error rate del orquestador por intent > 5% durante 10m con tráfico > 0.2 rps. Revisar logs e integraciones (PMS, NLP)."
          runbook_url: "https://grafana.local/runbooks#orchestratorhigherrorrate"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=11"

      - alert: OrchestratorHighErrorRateCritical
        expr: (sum by (intent) (rate(orchestrator_errors_total[5m])) / sum by (intent) (rate(orchestrator_messages_total[5m]))) > 0.2 and sum by (intent) (rate(orchestrator_messages_total[5m])) > 0.5
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Alta tasa de errores en Orchestrator (critical)"
          description: "El error rate del orquestador por intent > 20% durante 5m con tráfico > 0.5 rps. Priorizar investigación."
          runbook_url: "https://grafana.local/runbooks#orchestratorhigherrorrate"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=11"

      - alert: OrchestratorHighLatencyP95
        expr: max by (intent) (histogram_quantile(0.95, sum by (le, intent) (rate(orchestrator_latency_seconds_bucket[5m])))) > 2
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Latencia p95 alta en Orchestrator"
          description: "El p95 de latencia del orquestador supera 2s durante 10m para algún intent. Revisar dependencias (PMS, Redis) y carga."
          runbook_url: "https://grafana.local/runbooks#orchestratorhighlatencyp95"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=8"

      - alert: OrchestratorSLODegradationWarning
        expr: orchestrator_success_rate_all < 99 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "SLO del Orchestrator en degradación (warning)"
          description: "El success rate global del orquestador está por debajo de 99% durante 30m. Revisar intents con mayor error% y dependencias."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=12"

      - alert: OrchestratorSLODegradationCritical
        expr: orchestrator_success_rate_all < 97 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "SLO del Orchestrator en degradación (critical)"
          description: "El success rate global del orquestador está por debajo de 97% durante 10m. Atender de inmediato; revisar intents top-k por error% y latencia."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=12"

      # Burn rate SLO 99% (error budget 1%) - multi-ventana
      - alert: OrchestratorSLOBurnRateWarning
        expr: (orchestrator_burn_rate_fast > 2) and (orchestrator_burn_rate_slow > 1) and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "SLO burn rate alto (warning)"
          description: "Consumo acelerado del error budget: fast>2 y slow>1. Chequear intents con mayor error% y latencia."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=14"

      - alert: OrchestratorSLOBurnRateCritical
        expr: (orchestrator_burn_rate_fast2 > 14.4) and (orchestrator_burn_rate_slow2 > 6) and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "SLO burn rate crítico"
          description: "Consumo muy alto del error budget: fast2>14.4 y slow2>6. Atender de inmediato."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=14"

      - alert: OrchestratorSLOBudgetExhaustForecastWarning
        expr: orchestrator_error_budget_hours_to_exhaust_fast > 0 and orchestrator_error_budget_hours_to_exhaust_fast < 12 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "SLO: presupuesto se agotará (<12h)"
          description: "Proyección indica agotamiento del error budget en <12h (ventana fast). Iniciar mitigaciones y reducción de errores."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/slo-health/SLO%20Health"

      - alert: OrchestratorSLOBudgetExhaustForecastCritical
        expr: orchestrator_error_budget_hours_to_exhaust_fast > 0 and orchestrator_error_budget_hours_to_exhaust_fast < 6 and orchestrator_message_rate_all > orchestrator_slo_traffic_floor
        for: 15m
        labels:
          severity: critical
        annotations:
          summary: "SLO: presupuesto se agotará (<6h)"
          description: "Proyección indica agotamiento del error budget en <6h (ventana fast). Escalar incidente y priorizar resolución."
          runbook_url: "https://grafana.local/runbooks#orchestratorslo"
          dashboard: "grafana:/d/slo-health/SLO%20Health"

      - alert: PmsCacheHitRatioLowWarning
        expr: pms_cache_hit_ratio < 0.7 and (sum(rate(pms_cache_hits_total[5m])) + sum(rate(pms_cache_misses_total[5m])) > 0.2)
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "PMS cache hit ratio bajo (warning)"
          description: "Hit ratio < 70% durante 15m con actividad de cache > 0.2 ops/s. Revisar caducidad TTL, patrones de key o invalidaciones excesivas."
          runbook_url: "https://grafana.local/runbooks#pmscachehitratio"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=21"

      - alert: PmsCacheHitRatioLowCritical
        expr: pms_cache_hit_ratio < 0.5 and (sum(rate(pms_cache_hits_total[5m])) + sum(rate(pms_cache_misses_total[5m])) > 0.2)
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "PMS cache hit ratio muy bajo (critical)"
          description: "Hit ratio < 50% durante 10m con actividad de cache > 0.2 ops/s. Impacto potencial en latencia hacia PMS. Aplicar mitigaciones inmediatas."
          runbook_url: "https://grafana.local/runbooks#pmscachehitratio"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=21"

      # Predictive Circuit Breaker Alerts
      - alert: PmsCircuitBreakerImminentOpenWarning
        expr: (pms_cb_risk_imminent > 0.5) and (pms_cb_failure_streak_fraction >= 0.6) and (pms_cb_failure_ratio_5m > 0.4)
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Riesgo de apertura del Circuit Breaker PMS (warning)"
          description: "El CB muestra racha >=60% del umbral y failure ratios elevados (1m/5m). Posible apertura inminente si continúan fallos. Revisar latencias/errores del PMS."
          runbook_url: "https://grafana.local/runbooks#circuitbreakerimminent"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=5"

      - alert: PmsCircuitBreakerImminentOpenCritical
        expr: (pms_cb_failure_streak_fraction >= 0.8) and (pms_cb_failure_ratio_1m > 0.6) and (pms_cb_failure_ratio_5m > 0.5)
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Apertura inminente del Circuit Breaker PMS (critical)"
          description: "La racha de fallos (>=80% del umbral) y los ratios de fallo recientes son altos. Intervenir antes de apertura (verificar PMS upstream, timeouts, latencia)."
          runbook_url: "https://grafana.local/runbooks#circuitbreakerimminent"
          dashboard: "grafana:/d/agente-overview/Agente%20Hotel%20-%20Overview?viewPanel=5"

      # Database & Connection Pool Alerts
      - alert: DatabasePoolExhaustionCritical
        expr: db_pool_utilization_percent > 90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Connection pool cerca de agotamiento (>90%)"
          description: "La utilización del connection pool es {{ $value }}%. Riesgo de timeouts en nuevas conexiones. Aumentar POSTGRES_POOL_SIZE o POSTGRES_MAX_OVERFLOW."
          runbook_url: "https://grafana.local/runbooks#databasepoolexhaustion"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=1"

      - alert: DatabasePoolExhaustionWarning
        expr: db_pool_utilization_percent > 75
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Connection pool con alta utilización (>75%)"
          description: "La utilización del connection pool es {{ $value }}%. Monitorear de cerca y considerar incremento de pool_size."
          runbook_url: "https://grafana.local/runbooks#databasepoolexhaustion"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=1"

      - alert: DatabaseLongRunningQueries
        expr: db_pool_long_running_queries >= 3
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Múltiples queries de larga duración detectadas"
          description: "{{ $value }} queries ejecutándose por más de 30s. Puede indicar missing indexes, locks o N+1 queries. Ejecutar monitor_connections.py para detalles."
          runbook_url: "https://grafana.local/runbooks#databaselongqueries"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=3"

      - alert: DatabaseIdleInTransaction
        expr: db_pool_idle_in_transaction > 3
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Conexiones idle-in-transaction detectadas"
          description: "{{ $value }} conexiones en estado idle-in-transaction. Posible transaction leak - revisar commit/rollback en código."
          runbook_url: "https://grafana.local/runbooks#databaseidleintransaction"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=2"

      - alert: DatabasePoolOverflowHigh
        expr: db_pool_overflow > 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Alto uso de overflow connections"
          description: "{{ $value }} conexiones usando el overflow pool. El pool base es insuficiente para la carga actual. Aumentar POSTGRES_POOL_SIZE."
          runbook_url: "https://grafana.local/runbooks#databasepooloverflow"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=9"

      # --- Nuevas alertas básicas solicitadas ---
      - alert: DBConnectionsHigh
        expr: db_connections_active > 4
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Número de conexiones DB activo > 4"
          description: "Se detectan >4 conexiones activas sostenidas por más de 2m (umbral básico). Revisar picos de carga o fugas de conexiones."
          runbook_url: "https://grafana.local/runbooks#dbconnectionshigh"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=2"

      - alert: StatementTimeoutsPresent
        expr: increase(db_statement_timeouts_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Se detectan statement_timeouts"
          description: "Una o más sentencias alcanzaron statement_timeout en los últimos 5m. Revisar queries lentas / índices."
          runbook_url: "https://grafana.local/runbooks#statementtimeout"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=3"

      - alert: HighErrorRate5xx
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Alta tasa de errores 5xx (>5%)"
          description: "{{ $value | humanizePercentage }} de requests retornando 5xx. Correlacionar con pool exhaustion o circuit breaker state."
          runbook_url: "https://grafana.local/runbooks#higherrorrate5xx"
          dashboard: "grafana:/d/database-pms-performance/Database%20%26%20PMS%20Performance?viewPanel=10"

      # Session Management Alerts
      - alert: SessionsHighWarning
        expr: session_active_total > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Alto número de sesiones activas (>100)"
          description: "Se detectan {{ $value }} sesiones activas sostenidas por más de 10m. Revisar patrones de uso y configurar limpieza si es necesario."
          runbook_url: "https://grafana.local/runbooks#sessionshigh"
          dashboard: "grafana:/d/supabase-basico/Supabase%20B%C3%A1sico%20-%20Operaci%C3%B3n"

      - alert: SessionsHighCritical
        expr: session_active_total > 200
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Número crítico de sesiones activas (>200)"
          description: "Se detectan {{ $value }} sesiones activas. Posible memory leak o fallo en cleanup task. Revisar inmediatamente."
          runbook_url: "https://grafana.local/runbooks#sessionshigh"
          dashboard: "grafana:/d/supabase-basico/Supabase%20B%C3%A1sico%20-%20Operaci%C3%B3n"

      - alert: SessionLeakDetected
        expr: deriv(session_active_total[30m]) > 0.5
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Posible memory leak en sesiones"
          description: "Crecimiento sostenido de sesiones activas (>0.5/min en 30m, sostenido 1h). Indicativo de fallo en limpieza o expiración. Revisar cleanup task y TTL."
          runbook_url: "https://grafana.local/runbooks#sessionleak"
          dashboard: "grafana:/d/supabase-basico/Supabase%20B%C3%A1sico%20-%20Operaci%C3%B3n"

      - alert: SessionCleanupFailures
        expr: increase(session_cleanup_total{result="error"}[1h]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fallos frecuentes en cleanup de sesiones"
          description: "{{ $value }} errores de cleanup en última hora. Revisar logs de session_manager y conectividad a Redis."
          runbook_url: "https://grafana.local/runbooks#sessioncleanup"
          dashboard: "grafana:/d/supabase-basico/Supabase%20B%C3%A1sico%20-%20Operaci%C3%B3n"

      # Lock Service Alerts
      - alert: LockConflictsHigh
        expr: sum(rate(lock_conflicts_total[5m])) > 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Alta tasa de conflictos de lock (>0.5 rps)"
          description: "{{ $value }} conflictos/seg en últimos 5m. Posible contención de recursos (double-booking attempts) o problema en date range validation. Revisar logs de lock_service."
          runbook_url: "https://grafana.local/runbooks#lockconflicts"
          dashboard: "grafana:/d/resilience-dashboard/Resilience%20Dashboard"

      - alert: LockConflictsCritical
        expr: sum(rate(lock_conflicts_total[5m])) > 2
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Tasa crítica de conflictos de lock (>2 rps)"
          description: "{{ $value }} conflictos/seg sostenidos. Impacto severo en disponibilidad de reservas. Escalar investigación inmediatamente."
          runbook_url: "https://grafana.local/runbooks#lockconflicts"
          dashboard: "grafana:/d/resilience-dashboard/Resilience%20Dashboard"

      - alert: LockExtensionsExceeded
        expr: sum(rate(lock_extensions_total{result="max_reached"}[5m])) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Locks alcanzando máximo de extensiones frecuentemente"
          description: "{{ $value }} locks/seg alcanzaron max_extensions. Indicativo de transacciones lentas o procesos estancados. Revisar lógica de reserva y aumentar TTL inicial si es necesario."
          runbook_url: "https://grafana.local/runbooks#lockextensions"
          dashboard: "grafana:/d/resilience-dashboard/Resilience%20Dashboard"

      - alert: LockOperationsFailureRate
        expr: (sum(rate(lock_operations_total{result!="success"}[5m])) / sum(rate(lock_operations_total[5m]))) > 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Alta tasa de fallos en operaciones de lock (>10%)"
          description: "{{ $value | humanizePercentage }} de operaciones de lock fallando. Revisar conectividad a Redis y lógica de acquire/extend/release."
          runbook_url: "https://grafana.local/runbooks#lockfailures"
          dashboard: "grafana:/d/resilience-dashboard/Resilience%20Dashboard"

      # ----------------------------------------------------------------------
      # Prueba rápida (comentada por defecto)
      # Descomentar para probar pipeline de alertas; recuerda volver a comentar.
      # - alert: AlwaysFiring
      #   expr: vector(1)
      #   for: 1m
      #   labels:
      #     severity: critical
      #   annotations:
      #     summary: "Alerta de prueba (AlwaysFiring)"
      #     description: "Alerta sintética para validar receivers y ruteo."
