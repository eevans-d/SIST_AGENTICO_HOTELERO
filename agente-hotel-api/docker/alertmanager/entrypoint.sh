#!/bin/sh
set -eu

# Use a writable path inside the container
CFG="/tmp/generated.yml"

# Detect receivers from env
HAS_SLACK=0
if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
  HAS_SLACK=1
fi

HAS_EMAIL=0
if [ -n "${ALERT_EMAIL_TO:-}" ] && [ -n "${SMTP_HOST:-}" ] && [ -n "${SMTP_PORT:-}" ] && { [ -n "${SMTP_USER:-}" ] || [ -n "${SMTP_USERNAME:-}" ]; } && [ -n "${SMTP_PASSWORD:-}" ]; then
  HAS_EMAIL=1
fi

# Backward compat: prefer SMTP_USERNAME, fallback to SMTP_USER
SMTP_AUTH_USER="${SMTP_USERNAME:-${SMTP_USER:-}}"

# PagerDuty support (SPOF fix)
HAS_PD=0
if [ -n "${PAGERDUTY_INTEGRATION_KEY:-}" ]; then
  HAS_PD=1
fi

# Webhook fallback (agente-api)
ALERT_WEBHOOK_URL="${ALERT_WEBHOOK_URL:-http://agente-api:8000/api/v1/alerts/webhook}"
HAS_WEBHOOK=0
if [ -n "${ALERT_WEBHOOK_URL:-}" ]; then
  HAS_WEBHOOK=1
fi

SLACK_CHANNEL="${SLACK_CHANNEL:-#alertas-agente}"
EMAIL_FROM="${ALERT_EMAIL_FROM:-alerts@example.com}"

AM_GROUP_BY=${AM_GROUP_BY:-alertname,severity}
AM_GROUP_WAIT=${AM_GROUP_WAIT:-30s}
AM_GROUP_INTERVAL=${AM_GROUP_INTERVAL:-5m}
AM_REPEAT_INTERVAL=${AM_REPEAT_INTERVAL:-3h}

# Convert comma-separated group_by into YAML inline list with quotes
GROUP_BY_INLINE=$(printf "%s" "$AM_GROUP_BY" | sed "s/[^,][^,]*/'&'/g; s/,/, /g")

# Base config
cat > "$CFG" <<EOF
# generated by entrypoint.sh
global:
  resolve_timeout: 5m

route:
  receiver: "null"
  group_by: [$GROUP_BY_INLINE]
  group_wait: $AM_GROUP_WAIT
  group_interval: $AM_GROUP_INTERVAL
  repeat_interval: $AM_REPEAT_INTERVAL
EOF

# Conditional routes
if [ "$HAS_SLACK" -eq 1 ] || [ "$HAS_EMAIL" -eq 1 ] || [ "$HAS_PD" -eq 1 ] || [ "$HAS_WEBHOOK" -eq 1 ]; then
  cat >> "$CFG" <<'EOF'
  routes:
EOF
fi

# Critical severity â†’ receiver 'critical' (may include PD + Email + Slack + Webhook)
if [ "$HAS_SLACK" -eq 1 ] || [ "$HAS_EMAIL" -eq 1 ] || [ "$HAS_PD" -eq 1 ] || [ "$HAS_WEBHOOK" -eq 1 ]; then
  cat >> "$CFG" <<'EOF'
    - matchers:
        - severity = critical
      receiver: critical
EOF
fi

# Warning severity â†’ receiver 'warning' (Email + Webhook if available)
if [ "$HAS_EMAIL" -eq 1 ] || [ "$HAS_WEBHOOK" -eq 1 ] || [ "$HAS_SLACK" -eq 1 ]; then
  cat >> "$CFG" <<'EOF'
    - matchers:
        - severity = warning
      receiver: warning
EOF
fi

# Receivers section
cat >> "$CFG" <<'EOF'
receivers:
  - name: "null"
EOF

# Receiver: critical (multi-channel)
if [ "$HAS_SLACK" -eq 1 ] || [ "$HAS_EMAIL" -eq 1 ] || [ "$HAS_PD" -eq 1 ] || [ "$HAS_WEBHOOK" -eq 1 ]; then
  cat >> "$CFG" <<'EOF'
  - name: critical
EOF

  if [ "$HAS_PD" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    pagerduty_configs:
      - service_key: ${PAGERDUTY_INTEGRATION_KEY}
        severity: critical
        description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
        client: 'AlertManager - Agente Hotelero'
        client_url: '{{ .ExternalURL }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
EOF
  fi

  if [ "$HAS_EMAIL" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    email_configs:
      - to: ${ALERT_EMAIL_TO}
        from: ${EMAIL_FROM}
        smarthost: ${SMTP_HOST}:${SMTP_PORT}
        auth_username: ${SMTP_AUTH_USER}
        auth_password: ${SMTP_PASSWORD}
        require_tls: true
        headers:
          Subject: 'ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
EOF
  fi

  if [ "$HAS_SLACK" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: "${SLACK_CHANNEL}"
        send_resolved: true
        title: "[CRITICAL] {{ .CommonLabels.alertname }}"
        text: >-
          {{ range .Alerts }}â€¢ {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
EOF
  fi

  if [ "$HAS_WEBHOOK" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    webhook_configs:
      - url: ${ALERT_WEBHOOK_URL}
        send_resolved: true
EOF
  fi
fi

# Receiver: warning (email + slack + webhook as available)
if [ "$HAS_EMAIL" -eq 1 ] || [ "$HAS_SLACK" -eq 1 ] || [ "$HAS_WEBHOOK" -eq 1 ]; then
  cat >> "$CFG" <<'EOF'
  - name: warning
EOF
  if [ "$HAS_EMAIL" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    email_configs:
      - to: ${ALERT_EMAIL_TO}
        from: ${EMAIL_FROM}
        smarthost: ${SMTP_HOST}:${SMTP_PORT}
        auth_username: ${SMTP_AUTH_USER}
        auth_password: ${SMTP_PASSWORD}
        require_tls: true
        headers:
          Subject: 'âš ï¸  WARNING: {{ .GroupLabels.alertname }}'
EOF
  fi
  if [ "$HAS_SLACK" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    slack_configs:
      - api_url: ${SLACK_WEBHOOK_URL}
        channel: "${SLACK_CHANNEL}"
        send_resolved: true
        title: "[WARNING] {{ .CommonLabels.alertname }}"
        text: >-
          {{ range .Alerts }}â€¢ {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
EOF
  fi
  if [ "$HAS_WEBHOOK" -eq 1 ]; then
    cat >> "$CFG" <<EOF
    webhook_configs:
      - url: ${ALERT_WEBHOOK_URL}
        send_resolved: true
EOF
  fi
fi

# Inhibit rules to reduce noise: critical inhibits warning of same alertname
cat >> "$CFG" <<'EOF'
inhibit_rules:
  - source_matchers:
      - severity = critical
    target_matchers:
      - severity = warning
    equal: ['alertname']
EOF

echo "Using generated Alertmanager config:" >&2
echo "-----------------------------------" >&2
cat "$CFG" >&2
echo "-----------------------------------" >&2

exec /bin/alertmanager \
  --config.file="$CFG" \
  --storage.path=/tmp/alertmanager \
  --log.level=info
