<!-- [AUTOGENERATED GA-DEPLOY] Checklist de Pre-Despliegue a STAGING -->
# Checklist de Pre-Despliegue a Staging (Agente Hotelero IA)

Estado: ACTIVA | Versión: 1.0 | Fecha: 2025-11-08  
Responsable Ejecución: __________________  
Ventana de Despliegue: ____ UTC a ____ UTC  
Rollback Máximo Permitido: 15 minutos  

## 1. Alcance del Despliegue
| Ítem | Incluye | Excluye |
|------|---------|---------|
| Backend FastAPI | Código app (`agente-api`) | Refactor profundo NLP |
| Infra Observabilidad | Prometheus, Grafana, Alertmanager | Integración Loki |
| Métricas Seguridad | `jwt_sessions_active`, `db_connections_active`, `password_rotations_total` | Nuevas métricas de negocio |
| Documentación | Guías operativas y readiness report | Manual de formación hotel |

## 2. Pre-Requisitos Generales
Marcar con ✅ cuando esté verificado.

| Check | Estado | Evidencia / Comando |
|-------|--------|---------------------|
| Repositorio limpio (sin cambios unstaged) | ☐ | `git status` |
| Branch `main` actualizado | ☐ | `git pull origin main` |
| Tags previos listados (para rollback) | ☐ | `git tag --sort=-creatordate | head -n5` |
| Archivo `.env.staging` generado | ☐ | `ls -la .env.staging` |
| Secretos NO dummy (`change-me`) | ☐ | `grep -i "change-me" .env.staging || echo OK` |
| Imagen base construye local | ☐ | `docker build -f Dockerfile.production .` |
| Preflight ejecutado (decisión GO) | ☐ | `make preflight` |
| Tests críticos pasan (integración) | ☐ | `pytest tests/integration -k security` |

## 3. Infraestructura
| Componente | Acción | Estado | Evidencia |
|------------|--------|--------|----------|
| Red Docker | Verificar redes `backend_network` y `frontend_network` | ☐ | `docker network ls` |
| Volúmenes persistentes | Confirmar creados | ☐ | `docker volume ls | grep agente` |
| Puertos libres (8002, 9090, 3000, 9093) | Escaneo | ☐ | `ss -tulpn | egrep ':8002|:9090|:3000|:9093'` |
| Certificados TLS (si aplica) | Presencia | ☐ | `ls docker/nginx/ssl` |

## 4. Base de Datos
| Ítem | Acción | Estado | Evidencia |
|------|--------|--------|----------|
| Conectividad Postgres | `psql`/`asyncpg` conecta | ☐ | `python -c 'import asyncpg,asyncio,os;asyncio.run(asyncpg.connect(os.getenv("POSTGRES_URL")))'` |
| Migraciones (si hubiera) | Sin pendientes | ☐ | `alembic current` |
| Backup lógico antes | Dump snapshot | ☐ | `pg_dump $POSTGRES_URL > backup_$(date +%F).sql` |
| Tablas críticas existen | sessions / tenants | ☐ | `psql -c "\dt"` |

## 5. Redis
| Check | Estado | Evidencia |
|-------|--------|----------|
| Conexión | ☐ | `redis-cli -h host -a $REDIS_PASSWORD ping` |
| Memoria bajo umbral | ☐ | `redis-cli info memory | grep used_memory_human` |
| TTL sesiones correcto | ☐ | Script verificación |

## 6. Seguridad
| Ítem | Estado | Evidencia |
|------|--------|----------|
| JWT expira según política | ☐ | Revisar `settings` |
| Rotación de password métrica activa | ☐ | Curl `/metrics` |
| Headers de seguridad Nginx activos | ☐ | `curl -I https://staging-url` |
| Dependencias sin CVE crítico | ☐ | `make security-fast` |

## 7. Observabilidad
| Métrica / Check | Estado | Nota |
|-----------------|--------|------|
| `jwt_sessions_active` > 0 tras login test | ☐ |  |
| `db_connections_active` estable (<20) | ☐ |  |
| Dashboards Grafana cargan | ☐ | Panel "Supabase Básico" |
| Alertmanager UI accesible | ☐ | /#/status |
| Traces Jaeger generados | ☐ | Buscar operación webhook |

## 8. Plan de Despliegue
1. Crear tag pre-despliegue: `git tag -a vSTAGING-YYYYMMDD -m "Staging release" && git push --tags`  
2. Construir imágenes: `docker compose -f docker-compose.staging.yml build`  
3. Levantar stack: `docker compose -f docker-compose.staging.yml --profile pms up -d`  
4. Validar health: `curl http://staging-host/health/ready` (esperar 200)  
5. Ejecutar smoke tests: `pytest tests/integration -k basic --maxfail=1`  
6. Verificar métricas en Prometheus y panel Grafana  
7. Registrar resultado en sección Post-Despliegue  

## 9. Criterios GO / NO-GO
| Criterio | Umbral | Resultado | Decisión |
|----------|--------|-----------|----------|
| Health `/ready` estable | 3 checks consecutivos 200 | ☐ |  |
| Error rate < 2% (5m) | `rate(http_requests_total{status=~"5.."}[5m])` | ☐ |  |
| P95 latency < 800ms | PromQL panel | ☐ |  |
| Circuit breaker PMS cerrado | `pms_circuit_breaker_state == 0` | ☐ |  |
| Alertas críticas = 0 | Alertmanager | ☐ |  |

## 10. Plan de Rollback (<=15 min)
| Paso | Acción |
|------|--------|
| 1 | `docker compose logs --tail=200 agente-api` (diagnóstico rápido) |
| 2 | `docker compose ps` verificar contenedores degradados |
| 3 | `git checkout <tag-anterior> && docker compose build && up -d` |
| 4 | Restaurar backup DB si hubo migraciones destructivas |
| 5 | Confirmar recuperación health y métricas |

## 11. Post-Despliegue (llenar)
| Métrica | Valor 5m | Valor 30m | Observación |
|---------|----------|-----------|-------------|
| Error Rate |  |  |  |
| P95 Latency |  |  |  |
| JWT Sessions |  |  |  |
| DB Conns |  |  |  |
| Alertas Críticas |  |  |  |

## 12. Firmas
| Rol | Nombre | Fecha | Aprobado |
|-----|--------|-------|----------|
| Dev Backend | | | ☐ |
| Ops / SRE | | | ☐ |
| Product / Negocio | | | ☐ |

---
NOTA: Guarda este archivo como evidencia en el commit final del despliegue (añadir sufijo `_FILLED`).
