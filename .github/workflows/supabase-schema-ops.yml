name: Supabase Schema Ops

on:
  workflow_dispatch:
    inputs:
      apply:
        description: "Apply schema before validating?"
        type: boolean
        default: true
      validate_only:
        description: "Run only validation (skip apply)?"
        type: boolean
        default: false
      confirm_seed:
        description: "Run minimal seed (tenant + admin) after validation?"
        type: boolean
        default: false

permissions:
  contents: read

# Evita ejecuciones concurrentes costosas: si se dispara otra, cancela la anterior
concurrency:
  group: supabase-schema-ops
  cancel-in-progress: true

jobs:
  run:
    name: Test → (optional) Apply → Validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      # DATABASE_URL must be a Supabase pooler URL with sslmode=require
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Check secrets present
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL secret is missing" >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          # Prefer project requirements; fall back to minimal libs if not present
          if [ -f agente-hotel-api/requirements-test.txt ]; then
            python -m pip install -r agente-hotel-api/requirements-test.txt
          elif [ -f agente-hotel-api/requirements.txt ]; then
            python -m pip install -r agente-hotel-api/requirements.txt
          fi
          # Ensure essentials for scripts
          python -m pip install 'SQLAlchemy>=2.0' asyncpg psycopg2-binary

      - name: Test Supabase connection
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PYTHONPATH: agente-hotel-api
        run: |
          python agente-hotel-api/scripts/test_supabase_connection.py

      - name: Apply schema (optional)
        if: ${{ inputs.validate_only == false && inputs.apply == true }}
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PYTHONPATH: agente-hotel-api
        run: |
          # Sanity checks para evitar costos por mala configuración
          if ! echo "$DATABASE_URL" | grep -q ".pooler.supabase.com:6543"; then
            echo "DATABASE_URL no parece apuntar al pooler de Supabase (:6543). Aborting." >&2
            exit 1
          fi
          if ! echo "$DATABASE_URL" | grep -qi "sslmode=require"; then
            echo "DATABASE_URL sin sslmode=require. Aborting." >&2
            exit 1
          fi
          SCHEMA_FILE="agente-hotel-api/docs/supabase/schema.sql"
          if [ ! -f "$SCHEMA_FILE" ]; then
            echo "Schema file not found at $SCHEMA_FILE" >&2
            exit 1
          fi
          # Requiere confirmación explícita para evitar aplicaciones accidentales
          python agente-hotel-api/scripts/apply_supabase_schema.py --schema-file "$SCHEMA_FILE" --yes

      - name: Validate schema
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PYTHONPATH: agente-hotel-api
        run: |
          python agente-hotel-api/scripts/validate_supabase_schema.py

  seed:
    name: Optional Seed (Tenant + Admin)
    runs-on: ubuntu-latest
    needs: run
    if: ${{ inputs.confirm_seed == true }}
    timeout-minutes: 10
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      SUPABASE_ADMIN_PASSWORD: ${{ secrets.SUPABASE_ADMIN_PASSWORD }}
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "❌ DATABASE_URL secret missing" >&2; exit 1; fi
          if [ -z "${SUPABASE_ADMIN_PASSWORD}" ]; then
            echo "❌ SUPABASE_ADMIN_PASSWORD secret missing" >&2; exit 1; fi
          if [ "${SUPABASE_ADMIN_PASSWORD}" = "change-me" ] || [ "${SUPABASE_ADMIN_PASSWORD}" = "CHANGEME" ]; then
            echo "❌ SUPABASE_ADMIN_PASSWORD uses placeholder value" >&2; exit 1; fi
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          if [ -f agente-hotel-api/requirements-test.txt ]; then
            python -m pip install -r agente-hotel-api/requirements-test.txt
          elif [ -f agente-hotel-api/requirements.txt ]; then
            python -m pip install -r agente-hotel-api/requirements.txt
          fi
          python -m pip install asyncpg bcrypt SQLAlchemy>=2.0 psycopg2-binary
      - name: Execute seed (idempotent)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PYTHONPATH: agente-hotel-api
          ADMIN_PWD: ${{ env.SUPABASE_ADMIN_PASSWORD }}
        run: |
          if ! echo "$DATABASE_URL" | grep -q ".pooler.supabase.com:6543"; then
            echo "DATABASE_URL must target Supabase pooler (:6543) for seed" >&2; exit 1; fi
          if ! echo "$DATABASE_URL" | grep -qi "sslmode=require"; then
            echo "DATABASE_URL must include sslmode=require" >&2; exit 1; fi
          python agente-hotel-api/scripts/seed_supabase_minimal.py \
            --tenant default \
            --name "Default Tenant" \
            --identifier "+0000000000" \
            --admin-email admin@default.local \
            --admin-username admin \
            --admin-password "$ADMIN_PWD" \
            --update-if-exists
      - name: Seed completed
        run: echo "✅ Seed job finished (idempotent)"
