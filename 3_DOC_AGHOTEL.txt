Documentaci√≥n Complementaria Unificada: Agente Hotelero MVP
1. RESUMEN EJECUTIVO Y META-AN√ÅLISIS
Diagn√≥stico
La documentaci√≥n base del proyecto (Partes 1-5) presenta una arquitectura s√≥lida y pragm√°tica, viable para un desarrollador √∫nico y centrada en el PMS como √∫nica fuente de verdad. Sin embargo, un an√°lisis profundo mediante ingenier√≠a inversa revela "silencios elocuentes": √°reas cr√≠ticas que, aunque impl√≠citas, requieren documentaci√≥n expl√≠cita para garantizar la robustez, sostenibilidad y adopci√≥n exitosa del sistema a largo plazo.
Brechas Estrat√©gicas Identificadas
Este documento complementario aborda las siguientes brechas cr√≠ticas:
T√©cnicas: Falta de contratos de API formales, planes de contingencia espec√≠ficos y observabilidad avanzada (SLI/SLO).
Operativas: Ausencia de un sistema formal para la toma de decisiones del staff y de gu√≠as de debugging para un √∫nico desarrollador.
Culturales: La adaptaci√≥n al contexto argentino debe ir m√°s all√° del vocabulario, abarcando expectativas y matices culturales en la comunicaci√≥n.
De Sostenibilidad: Inexistencia de un plan para la transferencia de conocimiento (handover) y para la actualizaci√≥n continua de la propia documentaci√≥n.
Propuesta de Valor
La siguiente documentaci√≥n no expande el alcance funcional del agente, sino que fortalece significativamente su implementaci√≥n, operaci√≥n y evoluci√≥n. Transforma el proyecto de una "soluci√≥n viable" a un "sistema empresarial confiable y resiliente", manteniendo la filosof√≠a de simplicidad y desarrollo individual.
2. ROBUSTEZ T√âCNICA Y SOSTENIBILIDAD DEL SISTEMA
2.1. Especificaci√≥n de Contratos e Interfaces
Prop√≥sito: Eliminar ambig√ºedades entre m√≥dulos y con el PMS, acelerando el debugging y el mantenimiento futuro.
## CONTRATO DE MENSAJE UNIFICADO (WhatsApp/Gmail)
**Estructura Can√≥nica:**
{
  "message_id": "string (requerido)",
  "canal": "whatsapp|gmail",
  "user_id": "string (tel√©fono/email)",
  "timestamp_iso": "2024-09-01T10:30:00Z",
  "tipo": "text|audio|image",
  "texto": "string (vac√≠o si no aplica)",
  "media_url": "string|null",
  "metadata": {
    "confidence_stt": "float|null",
    "duration_sec": "integer|null"
  }
}

## MAPEO Y POL√çTICAS DEL PMS ADAPTER (QloApps)
**Endpoints Cr√≠ticos y Pol√≠ticas:**
- **GET /api/availability:**
  - Timeout: 8s
  - Retries: 3 (con backoff exponencial: 1s, 2s, 4s)
- **POST /api/reservations:**
  - Idempotencia: Utilizar un `reservation_uuid` √∫nico por intento.
- **Manejo de Errores Esperados:**
  - **401 Unauthorized:** Token de API inv√°lido. Notificar a admin.
  - **429 Too Many Requests:** L√≠mite de QloApps alcanzado. Reintentar con backoff.
  - **5xx Server Error:** Falla en el PMS. Activar modo degradado.


2.2. SLI/SLO y Sistema de Alertas
Prop√≥sito: Convertir el estado "funciona/no funciona" en m√©tricas operables con alertas autom√°ticas para una detecci√≥n proactiva de problemas.
## INDICADORES DE NIVEL DE SERVICIO (SLI)
- **Latencia Texto P95:** Tiempo desde que se recibe hasta que se responde.
- **Latencia Audio P95:** Tiempo desde que se recibe audio hasta que se responde.
- **Tasa de Error del Servidor (5xx):** % de requests al agente que fallan.
- **Disponibilidad del PMS:** % de √©xito en las llamadas a `/api/health` del PMS.

## OBJETIVOS DE NIVEL DE SERVICIO (SLO) Y ALERTAS
| SLI | Objetivo | Alerta (Warning) | Alerta (Critical) |
|---|---|---|---|
| Latencia Texto P95 | < 3s | > 4s | > 6s (por 5 min) |
| Latencia Audio P95 | < 15s | > 20s | > 30s (por 5 min) |
| Tasa de Error 5xx | < 1% | > 3% | > 5% (por 5 min) |
| Disponibilidad PMS | > 99.5%| < 99.5%| < 98% (por 10 min)|

**Canales de Alerta:**
- **Warning:** Email a administrador / Webhook a Slack/Discord.
- **Critical:** SMS a administrador + Email.


2.3. Manual de Transici√≥n y Sostenibilidad (Handover)
Prop√≥sito: Documentar el conocimiento t√°cito, las decisiones cr√≠ticas y los puntos fr√°giles del sistema para asegurar una transici√≥n suave a futuros desarrolladores y garantizar la continuidad del proyecto.
## üìú MANUAL DE TRANSICI√ìN DE PROPIEDAD

### 1. REGISTRO DE DECISIONES ARQUITECT√ìNICAS (ADR Log)
**ADR-001: Selecci√≥n de QloApps como PMS**
- **Decisi√≥n:** Usar QloApps en lugar de HotelDruid o desarrollo propio.
- **Razones:** API REST completa, comunidad activa, reduce 60-80% el desarrollo.
- **Consecuencias:** Dependencia externa cr√≠tica, curva de aprendizaje inicial.

**ADR-002: Elecci√≥n de WhatsApp Meta Cloud API sobre Twilio**
- **Decisi√≥n:** Utilizar la API nativa de Meta.
- **Razones:** Menor costo por mensaje, funcionalidades nativas completas.
- **Consecuencias:** Proceso de verificaci√≥n de Meta Business (1-3 d√≠as), menor flexibilidad que Twilio.

### 2. MAPA MENTAL DEL SISTEMA

```mermaid
graph TD
    A[Entradas: WhatsApp/Gmail] --> E[Procesamiento Central]
    E --> F{Tipo Mensaje: Texto/Audio}
    F -->|Texto| G[Normalizaci√≥n]
    F -->|Audio| H[STT con Whisper]
    G --> I[Motor NLU]
    H --> I
    I --> J{Intent Reconocido?}
    J -->|S√≠| K[Generaci√≥n de Respuesta]
    J -->|No| L[Fallback -> Matriz de Decisi√≥n Humana]
    K --> M{Acci√≥n Requerida?}
    M -->|S√≠| N[Integraci√≥n PMS: Disponibilidad/Reserva]
    M -->|No| O[Env√≠o Directo de Respuesta]
    N --> O


3. PUNTOS CR√çTICOS DE FRAGILIDAD
Procesamiento de Audio (STT): El modelo "base" de Whisper puede tener dificultades con acentos regionales marcados. Soluci√≥n: Si la confianza de transcripci√≥n es < 0.6, pedir al usuario que escriba.
Locks en Redis: Si Redis cae, existe un riesgo te√≥rico de doble-booking. Soluci√≥n: El sistema entra en modo degradado, requiriendo confirmaci√≥n manual doble.
Cambios en la API del PMS: La API de QloApps puede cambiar. Soluci√≥n: Pruebas de integraci√≥n automatizadas deben correr diariamente para detectar cambios.
4. PROTOCOLO DE TRANSFERENCIA DE CONOCIMIENTO
Checklist del Saliente: Documentar "puntos ciegos", grabar sesiones de troubleshooting, explicar decisiones de dise√±o no obvias.
Checklist del Entrante: Realizar cambios menores supervisado, diagnosticar problemas reales, proponer una mejora.
Transferencia Exitosa: El nuevo desarrollador puede resolver el 80% de las incidencias comunes y explicar las decisiones de dise√±o clave.
### 2.4. Sistema de Actualizaci√≥n Autom√°tica de Documentaci√≥n
**Prop√≥sito:** Convertir los logs operativos en mejoras concretas, creando un ciclo de mejora continua que mantiene la documentaci√≥n sincronizada con la realidad operativa.

```python
# app/documentation/auto_updater.py - Concepto
class DocumentationAutoUpdater:
    def __init__(self, redis_client):
        self.redis = redis_client

    async def run_weekly_update(self):
        """Ejecuta la actualizaci√≥n semanal de la documentaci√≥n."""
        # 1. Analizar logs para encontrar t√©rminos no reconocidos frecuentes.
        new_terms = await self._find_new_argentinian_terms()
        if new_terms:
            await self._propose_dictionary_update(new_terms)

        # 2. Identificar intents que m√°s derivan a fallback.
        problematic_intents = await self._analyze_fallback_patterns()
        if problematic_intents:
            await self._suggest_nlu_improvements(problematic_intents)

    async def _propose_dictionary_update(self, terms):
        # Genera una propuesta en el dashboard para que el staff
        # valide y agregue los nuevos t√©rminos al glosario.
        pass


3. RESILIENCIA OPERATIVA Y ADAPTACI√ìN CULTURAL (CONTEXTO ARGENTINO)
3.1. Matriz de Riesgos y Decisi√≥n para Intervenciones
Prop√≥sito: Sistematizar tanto la respuesta a fallos t√©cnicos como la priorizaci√≥n de intervenciones humanas, reduciendo la carga cognitiva del staff.
Contingencia T√©cnica
Riesgo (Falla del Sistema)
Probabilidad
Impacto
Detecci√≥n
Respuesta Autom√°tica
Ca√≠da de API de WhatsApp
Media
Cr√≠tico
Health checks fallan > 5 min
Activar "Modo Solo Email y PMS", notificar a admin.
Corrupci√≥n DB de QloApps
Baja
Cr√≠tico
Queries al PMS retornan SQL errors
Freeze de nuevas reservas, activar modo read-only, notificar para restore.

Decisi√≥n Operativa Humana
Urgencia (Hu√©sped)
Complejidad
Prioridad
Tiempo de Resp.
Acci√≥n Requerida
5 (Cr√≠tica)
3-5 (Compleja)
URGENTE
< 2 min
Derivaci√≥n inmediata + Llamada al staff de turno.
4 (Alta)
1-2 (Simple)
ALTA
< 15 min
Derivar a dashboard con notificaci√≥n prioritaria.
2 (Baja)
1-4 (Simple)
BAJA
< 24h
Registrar en dashboard para seguimiento al d√≠a siguiente.

Factores Moduladores (Ajustan la Urgencia):
Temporada Alta: +1 Urgencia
Hu√©sped en Estad√≠a: +1 Urgencia
Hu√©sped VIP/Frecuente: +1 Urgencia
3.2. Gu√≠a de Localizaci√≥n Cultural Profunda
Prop√≥sito: Ir m√°s all√° de la traducci√≥n de t√©rminos, abordando las expectativas culturales de los hu√©spedes argentinos para ofrecer una comunicaci√≥n aut√©ntica y efectiva.
## üåé GU√çA DE LOCALIZACI√ìN CULTURAL ARGENTINA

### 1. Relaci√≥n con el Tiempo (La "Hora Argentina")
- **Expectativa:** Flexibilidad en horarios de check-in/out.
- **Aplicaci√≥n:** Evitar rigidez. Usar frases como "El check-in es a partir de las 14:00, pero si lleg√°s antes, avisame y vemos qu√© se puede hacer".

### 2. Manejo de Conflictos (Directo con Tacto)
- **Expectativa:** Reconocimiento del problema antes de ofrecer una soluci√≥n.
- **Aplicaci√≥n:** Validar la queja primero. Usar "Ten√©s raz√≥n..."
- **‚ùå Incorrecto:** "El wifi funciona bien, debe ser tu dispositivo".
- **‚úÖ Correcto:** "Ten√©s raz√≥n, el wifi deber√≠a funcionar mejor. Ya mismo env√≠o a alguien a revisarlo".

### 3. El "No" Argentino
- **Expectativa:** Se evita el "no" directo.
- **Se√±ales:** Respuestas como "vamos a ver", "tal vez", "depende".
- **Aplicaci√≥n:** Si el sistema no puede cumplir un pedido, ofrecer alternativas claras en lugar de un "no" rotundo.

### 4. Glosario Din√°mico de Interacci√≥n (Ejemplos)
| T√©rmino | Definici√≥n | Nivel Formalidad | Riesgo Malentendido | Recomendaci√≥n |
|---|---|---|---|---|
| **"Finde"** | Fin de semana | Informal | Bajo | Aceptable en chat inicial, usar "fin de semana" en confirmaciones formales. |
| **"Se√±a"** | Anticipo de reserva| Neutral | Medio (Extranjeros) | Acompa√±ar siempre de una explicaci√≥n: "una se√±a (anticipo del 30%)". |
| **"Cochera"** | Estacionamiento | Neutral | Alto (Regiones) | Usar ambos t√©rminos: "cochera/garage" o el gen√©rico "estacionamiento". |


3.3. Consideraciones Legales y Privacidad (Ley 25.326)
Prop√≥sito: Establecer una referencia b√°sica sobre las implicaciones de la Ley de Protecci√≥n de Datos Personales de Argentina.
Principios Aplicados: Consentimiento (impl√≠cito al contactar), Finalidad (solo gesti√≥n hotelera), Seguridad (HTTPS, backups).
Pol√≠ticas de Retenci√≥n Clave:
Conversaciones no convertidas: 60 d√≠as ‚Üí Anonimizaci√≥n.
Datos de reservas completadas: 7 a√±os (requisito fiscal).
Archivos de audio: 30 d√≠as ‚Üí Eliminaci√≥n autom√°tica.
Disclaimer: Esto no constituye asesor√≠a legal. Se recomienda consultar a un abogado para un compliance completo.
4. PLAN DE IMPLEMENTACI√ìN Y RECOMENDACIONES
Roadmap Sugerido
D√≠as 1-5 (Cr√≠ticos Pre-Producci√≥n): Implementar Contratos de Interfaces (2.1), SLI/SLO (2.2) y la Matriz de Riesgos (3.1).
Semanas 2-4 (Operativos): Desarrollar la Gu√≠a Cultural y Glosario (3.2), Manual de Transici√≥n (2.3) y Consideraciones Legales (3.3).
Mes 2-3 (Evoluci√≥n): Implementar el sistema de Actualizaci√≥n Autom√°tica de Documentaci√≥n (2.4).
Recomendaci√≥n Final
La implementaci√≥n de esta documentaci√≥n complementaria convierte un proyecto funcional en un activo estrat√©gico, reduciendo dr√°sticamente el riesgo operativo y t√©cnico y mejorando la capacidad de mantenimiento y evoluci√≥n del sistema por parte de un desarrollador √∫nico. Se recomienda priorizar los documentos de la categor√≠a Cr√≠ticos Pre-Producci√≥n antes del lanzamiento final.
